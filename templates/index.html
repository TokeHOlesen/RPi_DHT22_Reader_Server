<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Temperatura i wilgotnośċ powietrza</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/stylesheet.css') }}" />
  <!-- Include Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // Global variables
    window.lastFetchedHistoryData = null;
    window.currentHistoryHours = 1;
    window.currentView = "table";
    // New flag: whether historical data is currently visible.
    window.historicalDataVisible = false;

    // Fetches the most recent sensor data
    function updateData() {
      fetch('/latest')
        .then(response => response.json())
        .then(data => {
          document.getElementById('temp').innerText = data.temp || "--";
          document.getElementById('hum').innerText = data.hum || "--";

          // Flash a green dot whenever new data is fetched
          const statusDot = document.getElementById('status-dot');
          statusDot.classList.add('flash');
          setTimeout(() => {
            statusDot.classList.remove('flash');
          }, 150);
        })
        .catch(error => console.error('Error fetching data:', error));
    }

    // Fetches historical data and updates the UI only if the history view is visible.
    function fetchHistory(hours) {
      window.currentHistoryHours = hours;
      
      fetch(`/history?hours=${hours}`)
        .then(response => response.json())
        .then(data => {
          // Save the data globally
          window.lastFetchedHistoryData = data;
          // Only update the UI if the historical view is visible.
          if (window.historicalDataVisible) {
            if (window.currentView === "graph") {
              updateGraph(data);
            } else {
              updateTable(data);
            }
          }
        })
        .catch(error => console.error("Błąd pobierania historii:", error));
    }

    // Helper function for the timespan buttons to both show the history view and fetch data.
    function showHistory(hours) {
      window.historicalDataVisible = true;
      fetchHistory(hours);
    }

    // Updates the table with historical data
    function updateTable(data) {
      const tableContainer = document.getElementById('table-container');
      const tableBody = document.getElementById('data-table-body');
      const dataControls = document.getElementById('data-controls');
      const graphContainer = document.getElementById('graph-container');
      const toggleBtn = document.getElementById('show-graph');

      // Populate the table
      tableBody.innerHTML = "";
      data.forEach(entry => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.datetime}</td>
          <td>${entry.temperature}°C</td>
          <td>${entry.humidity}%</td>
        `;
        tableBody.appendChild(row);
      });

      // Show the table view and the controls; hide the graph.
      tableContainer.style.display = "block";
      graphContainer.style.display = "none";
      dataControls.style.display = "flex";
      toggleBtn.innerText = "Pokaż wykres";
      window.currentView = "table";
    }

    // Updates (or creates) the graph with historical data
    function updateGraph(data) {
      const tableContainer = document.getElementById('table-container');
      const graphContainer = document.getElementById('graph-container');
      const canvas = document.getElementById('data-chart');
      const dataControls = document.getElementById('data-controls');
      const toggleBtn = document.getElementById('show-graph');

      // Show the graph view and the controls; hide the table.
      tableContainer.style.display = "none";
      graphContainer.style.display = "block";
      dataControls.style.display = "flex";
      toggleBtn.innerText = "Pokaż tabelę";

      // Adjust canvas size for responsiveness
      const containerWidth = graphContainer.clientWidth;
      const containerHeight = graphContainer.clientHeight;
      canvas.width = containerWidth * window.devicePixelRatio;
      canvas.height = containerHeight * window.devicePixelRatio;
      canvas.style.width = '100%';
      canvas.style.height = '100%';

      const ctx = canvas.getContext('2d');

      // Reverse the data so that the oldest entries are on the left
      const labels = data.map(entry => entry.datetime).reverse();
      const tempData = data.map(entry => entry.temperature).reverse();
      const humData = data.map(entry => entry.humidity).reverse();

      if (window.myChart) {
        window.myChart.data.labels = labels;
        window.myChart.data.datasets[0].data = tempData;
        window.myChart.data.datasets[1].data = humData;
        window.myChart.update();
      } else {
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Temperatura (°C)',
                data: tempData,
                borderColor: '#FF6384',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: false,
                tension: 0.1
              },
              {
                label: 'Wilgotność (%)',
                data: humData,
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: false,
                tension: 0.1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: { display: true }
              },
              y: {
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 100,
                title: { display: true }
              }
            }
          }
        });
      }
      window.currentView = "graph";
    }

    // Hides the historical data view and control buttons.
    function hideDataDisplay() {
      document.getElementById('table-container').style.display = "none";
      document.getElementById('graph-container').style.display = "none";
      document.getElementById('data-controls').style.display = "none";
      // Also mark the historical view as hidden.
      window.historicalDataVisible = false;
    }

    // Add event listeners once the document is loaded.
    document.addEventListener("DOMContentLoaded", function() {
      const toggleBtn = document.getElementById("show-graph");
      const tableContainer = document.getElementById('table-container');
      const graphContainer = document.getElementById('graph-container');

      // Toggle between table and graph views.
      toggleBtn.addEventListener("click", function() {
        if (window.currentView === "table") {
          window.currentView = "graph";
          tableContainer.style.display = "none";
          graphContainer.style.display = "block";
          toggleBtn.innerText = "Pokaż tabelę";
          if (window.lastFetchedHistoryData) {
            updateGraph(window.lastFetchedHistoryData);
          }
        } else {
          window.currentView = "table";
          graphContainer.style.display = "none";
          tableContainer.style.display = "block";
          toggleBtn.innerText = "Pokaż wykres";
        }
      });

      // Event listener for the "hide data" button.
      document.getElementById("hide-data").addEventListener("click", function() {
        hideDataDisplay();
      });

      // Automatically refresh historical data every minute, but only update the UI if visible.
      setInterval(function() {
        // You can check the flag to avoid an unnecessary UI update.
        if (window.historicalDataVisible) {
          fetchHistory(window.currentHistoryHours);
        } else {
          // Optionally, you might still update the global data without changing the UI.
          fetch(`/history?hours=${window.currentHistoryHours}`)
            .then(response => response.json())
            .then(data => {
              window.lastFetchedHistoryData = data;
            })
            .catch(error => console.error("Błąd pobierania historii:", error));
        }
      }, 60000);
    });

    // Refresh the sensor data view every second.
    setInterval(updateData, 1000);
    window.onload = updateData;
  </script>
</head>
<body>
  <!-- Displays the current sensor data -->
  <div class="data-box">
    <div class="status-dot" id="status-dot"></div>
    <div class="data-display"><span id="temp">--</span></div>
    <div class="data-display"><span id="hum">--</span></div>
  </div>

  <!-- Timespan selection buttons for historical data.
       Note: now they call showHistory() so that the historical view is flagged as visible. -->
  <div class="link-container">
    <a href="#" class="link-box" onclick="showHistory(1); event.preventDefault();">Ostania godzina</a>
    <a href="#" class="link-box" onclick="showHistory(6); event.preventDefault();">Ostatnie 6 godzin</a>
    <a href="#" class="link-box" onclick="showHistory(12); event.preventDefault();">Ostatnie 12 godzin</a>
    <a href="#" class="link-box" onclick="showHistory(24); event.preventDefault();">Ostatnie 24 godziny</a>
    <a href="#" class="link-box" onclick="showHistory(168); event.preventDefault();">Ostatni tydzień</a>
  </div>

  <!-- Data view control buttons (visible only when historical data is displayed) -->
  <div id="data-controls" class="button-container" style="display: none;">
    <button class="link-box" id="show-graph">Pokaż wykres</button>
    <button class="link-box" id="hide-data">Ukryj dane</button>
  </div>

  <!-- Graph container -->
  <div id="graph-container" class="graph-container" style="display: none;">
    <canvas id="data-chart"></canvas>
  </div>

  <!-- Table container -->
  <div id="table-container" class="table-container">
    <table id="data-table">
      <thead>
        <tr>
          <th>Czas</th>
          <th>Temperatura (°C)</th>
          <th>Wilgotność (%)</th>
        </tr>
      </thead>
      <tbody id="data-table-body"></tbody>
    </table>
  </div>
</body>
</html>
